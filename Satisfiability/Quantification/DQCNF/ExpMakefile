# Copyright 2020 Oliver Kullmann
# This file is part of the OKlibrary. OKlibrary is free software; you can redistribute
# it and/or modify it under the terms of the GNU General Public License as published by
# the Free Software Foundation and included in this library; either version 3 of the
# License, or any later version.

# Version 0.1.4

SHELL := /bin/bash
.SUFFIXES :
.PHONY : all run beginrun runjobs endrun transfer clean cleanall

MAKE_PID := $(shell echo $$PPID)
JOB_FLAG := $(filter -j%, $(subst -j ,-j,$(shell ps T | grep "^\s*$(MAKE_PID).*$(MAKE)")))
ifeq ($(JOB_FLAG),)
  JOBS := 1
else ifeq ($(JOB_FLAG),-j)
  JOBS := 96
else
  JOBS := $(subst -j,,$(JOB_FLAG))
endif

.ONESHELL :


group_id := 1959747134094409559
person_id ?= 0
timestamp ?= 1585901912134206048
seeds := $(group_id),$(person_id),$(timestamp)

parameters ?= "a400 400" 1200 "1600*2,3" ""
full_parameters := $(parameters) $(seeds)

joblist := $(shell for (( i=1; i<=$(JOBS); ++i )); do echo $$i; done)
joblist := $(addprefix experiments/,$(joblist))
.PHONY : $(joblist)

generator_call := DQBRG
reduction_call := A1Reduction


all : run transfer
run : beginrun runjobs endrun

beginrun :
	@echo -e "\nBegin run, PID=$(MAKE_PID)" >> Log
	date -Ins >> Log
	echo "Parallel: j=$(JOBS)" >> Log

runjobs : | beginrun
runjobs : $(joblist)

endrun : | runjobs
endrun :
	@echo >> Log
	ps -o "%t" --pid $(MAKE_PID) | tee -a Log
	echo "End run, PID=$(MAKE_PID)" >> Log
	date -Ins >> Log


$(joblist) : experiments/% :
	@cd experiments
	mkdir -p $*
	cd $*
	if [ ! -f N ]; then echo 0 > N; fi
	seed=$$(cat N)
	while [[ ! -f ../../END ]]; do output="$$($(generator_call) $(full_parameters),$*,$$seed | directory="working" $(reduction_call))"; echo "$$seed $$output" >> result; rm -r working; ((++seed)); done
	echo "$$seed" > N


transfer :
	@echo "# $(generator_call): "'$(full_parameters)' > Result
	echo "seed0 seed1 res rc auts" >> Result
	for dir in $(joblist); do if [[ -f $$dir ]]; then i=$$(basename $$dir); sed -e "s/^/$$i /" $$dir/result >> Result; fi; done

clean :
	rm -f END

cleanall : clean
	rm -r -f experiments/*
